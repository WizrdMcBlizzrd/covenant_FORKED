<%
  const bannerId =
    collection.gallery_inscription_id ??
    collection.parent_inscription_id ??
    (collection.inscription_ids ?? [])[0]

  let mintAttrs = ''
  if (!supply.isSoldOut && supply.hasMintable) {
    mintAttrs += ' data-controller="mint"'
    mintAttrs += ' data-action="wallet:connected@window->mint#onWalletConnected wallet:disconnected@window->mint#onWalletDisconnected"'
    mintAttrs += ` data-mint-collection-value="${collection.slug}"`
    mintAttrs += ` data-mint-price-value="${collection.price_sats}"`
    mintAttrs += ` data-mint-payment-address-value="${collection.payment_address}"`
    mintAttrs += ` data-mint-lowest-inscription-utxo-size-value="${collection.lowest_inscription_utxo_size}"`
    mintAttrs += ` data-mint-seller-address-value="${launchpad.seller_address}"`
    if (collection.explicit_fee_rate) {
      mintAttrs += ` data-mint-explicit-fee-rate-value="${collection.explicit_fee_rate}"`
    }
  }
%>

<section class="pb-6" data-testid="launchpad-page"<%- mintAttrs %>>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Left: Artwork -->
    <% if (CONFIG.launchpad_media_gif_url) { %>
      <div class="spam-can p-4" data-testid="launchpad-media">
        <img
          src="<%= CONFIG.launchpad_media_gif_url %>"
          alt="<%= collection.title %>"
          class="w-full aspect-[4/3] object-contain rounded border-2 border-spam-navy"
          data-testid="launchpad-media-gif"
        />
      </div>
    <% } else if (bannerId) { %>
      <div class="spam-can p-4" data-testid="launchpad-media" data-controller="image">
        <div class="relative aspect-[4/3]">
          <div class="absolute inset-0 bg-spam-bone-dark rounded animate-pulse" data-image-target="skeleton"></div>

          <% if (parentInscription && parentInscription.isImage) { %>
            <img
              src="https://ordinals.com/content/<%= encodeURIComponent(bannerId) %>"
              alt="<%= collection.title %>"
              loading="eager"
              decoding="async"
              style="image-rendering: pixelated"
              class="w-full h-full object-contain rounded border-2 border-spam-navy opacity-0 transition-opacity duration-300"
              data-image-target="img"
              data-action="load->image#loaded error->image#error"
              data-testid="launchpad-media-img"
            />
          <% } else { %>
            <iframe
              src="https://ordinals.com/preview/<%= encodeURIComponent(bannerId) %>"
              class="w-full h-full rounded border-2 border-spam-navy pointer-events-none opacity-0 transition-opacity duration-300"
              allow="accelerometer; gyroscope"
              data-image-target="media"
              data-action="load->image#loaded error->image#error"
              data-testid="launchpad-media-iframe"
            ></iframe>
          <% } %>
        </div>
      </div>
    <% } else { %>
      <div class="spam-can p-4" data-testid="launchpad-media">
        <div class="w-full aspect-[4/3] rounded border-2 border-spam-navy bg-spam-bone flex items-center justify-center">
          <span class="text-5xl">ðŸ¥«</span>
        </div>
      </div>
    <% } %>

    <!-- Right: Mint info / details -->
    <div class="spam-can p-6" data-testid="launchpad-details">
      <h1 class="font-display text-2xl text-spam-navy mb-2" data-testid="launchpad-title"><%= collection.title %></h1>

      <% if (collection.description) { %>
        <p class="font-body text-base leading-relaxed text-spam-navy mb-4" data-testid="launchpad-description"><%= collection.description %></p>
      <% } %>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="rounded-lg border-2 border-spam-navy bg-spam-bone p-4">
          <div class="font-body text-xs uppercase tracking-wide text-spam-navy/80">Price</div>
          <div class="font-display text-xl text-spam-navy" data-testid="launchpad-price"><%= collection.price_sats %> sats</div>
        </div>

        <div class="rounded-lg border-2 border-spam-navy bg-spam-bone p-4">
          <div class="font-body text-xs uppercase tracking-wide text-spam-navy/80">Supply</div>
          <div class="font-display text-xl text-spam-navy" data-testid="launchpad-supply">
            <%= supply.remaining %> / <%= supply.total %>
          </div>
        </div>
      </div>

      <% if (supply.isSoldOut || !supply.hasMintable) { %>
        <div class="rounded-xl border-4 border-spam-navy bg-spam-bone p-6 text-center" data-testid="launchpad-sold-out">
          <div class="text-5xl mb-3">ðŸ¥«</div>
          <div class="font-display text-xl text-spam-navy mb-1">Sold out</div>
          <div class="font-body text-sm text-spam-navy/80">No mintable items available right now.</div>
        </div>
      <% } else { %>
        <form method="post" data-testid="mint-form" data-mint-target="form">
          <% if ((collection.optional_payments ?? []).length > 0) { %>
            <div class="mb-4" data-testid="optional-payments">
              <div class="font-display text-sm text-spam-green mb-3">Include additional payments</div>
              <div class="space-y-2">
                <% collection.optional_payments.forEach((payment) => { %>
                  <label class="flex items-center justify-between gap-3 p-3 bg-spam-cream border-2 border-spam-navy rounded-lg hover:bg-spam-yellow/20 cursor-pointer" data-testid="optional-payment">
                    <div class="flex items-center gap-3">
                      <input class="w-4 h-4 accent-spam-green" type="checkbox" data-mint-target="optionalPayment" data-payment='<%= JSON.stringify(payment) %>' data-action="mint#calculateCost" />
                      <div>
                        <div class="font-body text-sm font-bold text-spam-navy"><%= payment.title %></div>
                        <div class="font-body text-xs text-spam-green-dark"><%= payment.description %></div>
                      </div>
                    </div>
                    <span class="font-display text-sm text-spam-green"><%= formatSats(payment.amount) %></span>
                  </label>
                <% }) %>
              </div>
            </div>
          <% } %>

          <% if (launchpad.turnstile_site_key) { %>
            <div class="mb-4 flex justify-center">
              <div
                class="cf-turnstile"
                data-mint-target="turnstile"
                data-sitekey="<%= launchpad.turnstile_site_key %>"
                data-callback="launchpadTurnstileSuccess"
                data-expired-callback="launchpadTurnstileExpired"
                data-error-callback="launchpadTurnstileError"
              ></div>
            </div>
          <% } %>

          <!-- Hidden targets required by mint controller -->
          <div class="hidden" aria-hidden="true">
            <span data-mint-target="fee">-</span>
            <span data-mint-target="feeRate">-</span>
            <button type="button" data-mint-target="connectButton">Connect</button>
            <button type="button" data-mint-target="prepareButton">
              <span data-mint-target="prepareSpinner" class="button-spinner button-spinner-hidden"></span>
              <span data-mint-target="prepareLabel">Prepare Mint</span>
            </button>
          </div>

          <!-- OP_RETURN Message box -->
          <% if (collection.op_return) { %>
            <div class="mb-4" data-testid="opreturn-section">
              <div class="rounded-xl border-4 border-spam-navy bg-spam-bone p-5">
                <div class="flex items-center justify-between gap-4 mb-3">
                  <div class="font-display text-lg text-spam-navy">OP_RETURN Message</div>
                  <button
                    type="button"
                    class="rounded-lg border-2 border-spam-navy bg-spam-yellow px-4 py-2 font-display text-sm text-spam-navy hover:bg-spam-cream transition-colors"
                    id="opreturn-randomise"
                  >
                    Randomise
                  </button>
                </div>

                <div class="font-body text-xs text-spam-navy/70 mb-2">
                  The Knotzi regime requires a minimum of 80kb OPRETURN data per Knotzi, irrespecitve of rank.
                  <span class="ml-2 font-display" id="opreturn-bytes">0 bytes</span>
                </div>

                <textarea
                  id="opreturn-message"
                  class="w-full min-h-[110px] rounded-lg border-2 border-spam-navy bg-spam-cream p-3 font-body text-sm text-spam-navy"
                  rows="3"
                  required
                  spellcheck="false"
                  autocomplete="off"
                  placeholder="Enter at least 81 bytes"
                  data-mint-target="spamInput"
                  data-action="input->mint#onSpamInput"
                ></textarea>
              </div>
            </div>
          <% } %>
        </form>

        <div class="show-on-connected mb-3 w-full flex items-center justify-between rounded-lg border-2 border-spam-navy bg-spam-bone px-4 py-3">
          <span class="font-display text-sm text-spam-navy">Total</span>
          <div class="text-right">
            <span class="font-display text-lg text-spam-navy" data-mint-target="total">-</span>
            <div class="hidden font-body text-xs text-spam-navy/60" data-usd-role="total" data-usd-sats=""></div>
          </div>
        </div>

        <div class="space-y-3" data-testid="launchpad-mint">
          <button
            class="hide-on-connected w-full rounded-xl border-4 border-spam-navy bg-white px-6 py-4 font-display text-lg text-spam-navy hover:bg-spam-green hover:text-spam-bone hover:border-spam-navy transition-colors cursor-pointer"
            type="button"
            onclick="document.querySelector('[data-testid=connect-wallet-button]')?.click()"
          >Connect wallet to mint</button>

          <button
            type="button"
            class="hidden w-full rounded-xl border-4 border-spam-navy bg-white px-6 py-4 font-display text-lg text-spam-navy hover:bg-spam-green hover:text-spam-bone hover:border-spam-navy transition-colors cursor-pointer"
            data-testid="mint-button"
            data-mint-target="mintButton"
            data-action="click->mint#mint"
          >
            <span class="inline-flex w-full items-center justify-center gap-2">
              <span data-mint-target="mintSpinner" class="button-spinner button-spinner-hidden"></span>
              <span data-mint-target="mintLabel">Mint</span>
            </span>
          </button>
        </div>

        <div class="hidden mt-4 p-4 bg-green-100 border-3 border-green-600 rounded-lg" data-mint-target="successPanel" data-testid="mint-success">
          <div class="font-display text-sm text-green-800" data-mint-target="successTitle">Mint Successful</div>
          <a class="font-body text-xs text-green-600 underline" target="_blank" rel="noopener" data-mint-target="successLink" href="">View transaction on mempool.space</a>
        </div>

        <div class="hidden mt-4 p-4 bg-red-100 border-3 border-red-600 rounded-lg" data-mint-target="errorPanel" data-testid="mint-client-error">
          <div class="font-display text-sm text-red-800" data-mint-target="errorTitle">Error</div>
          <div class="font-body text-xs text-red-600" data-mint-target="errorMessage"></div>
        </div>
      <% } %>
    </div>
  </div>

  <turbo-frame
    id="launchpad-sales"
    src="/launchpad/<%= encodeURIComponent(collection.slug) %>/sales"
    loading="lazy"
    refresh="morph"
    target="_top"
    class="block mt-4"
    data-controller="frame-refresh"
    data-frame-refresh-interval-value="<%= launchpad.refresh_ms %>"
  ></turbo-frame>

  <% if (collection.op_return) { %>
  <script>
    (function () {
      const enc = new TextEncoder()

      function byteLen(str) {
        return enc.encode(str).length
      }

      function setMessage(msg) {
        const ta = document.getElementById("opreturn-message")
        const bytesEl = document.getElementById("opreturn-bytes")

        if (ta) {
          ta.value = msg
          ta.dispatchEvent(new Event('input', { bubbles: true }))
        }
        if (bytesEl) bytesEl.textContent = byteLen(msg) + " bytes"
      }

      let LINES = []

      async function loadMessages() {
        const res = await fetch("/opreturn-messages.json", { cache: "no-store" })
        if (!res.ok) throw new Error("Failed to load /opreturn-messages.json (" + res.status + ")")

        const data = await res.json()

        const arr = Array.isArray(data) ? data : Array.isArray(data?.messages) ? data.messages : null
        if (!arr) throw new Error('JSON format not recognised. Use an array, or {"messages":[...]}')

        LINES = arr.map((s) => String(s ?? "").trim()).filter(Boolean)

        if (LINES.length === 0) throw new Error("No messages found in /opreturn-messages.json")
      }

      function randomise() {
        if (!LINES.length) {
          setMessage("Loading OP_RETURN messagesâ€¦")
          return
        }
        const pick = LINES[Math.floor(Math.random() * LINES.length)]
        setMessage(pick)
      }

      const btn = document.getElementById("opreturn-randomise")
      if (btn) btn.addEventListener("click", randomise)

      // Update byte counter on manual edits
      const ta = document.getElementById("opreturn-message")
      if (ta) ta.addEventListener("input", () => {
        const bytesEl = document.getElementById("opreturn-bytes")
        if (bytesEl) bytesEl.textContent = byteLen(ta.value) + " bytes"
      })

      loadMessages()
        .then(() => {
          randomise()
        })
        .catch((e) => {
          console.error(e)
          setMessage("ERROR loading messages. Check /opreturn-messages.json in /public and console logs.")
        })
    })();
  </script>
  <% } %>
</section>

<% if (launchpad.turnstile_site_key) { %>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<% } %>
