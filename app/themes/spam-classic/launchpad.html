<%
  const bannerId =
    collection.gallery_inscription_id ??
    collection.parent_inscription_id ??
    (collection.inscription_ids ?? [])[0]

  // Build mint attributes safely (avoid EJS control-flow inside tag attributes)
  let mintAttrs = ''
  if (!supply.isSoldOut && supply.hasMintable) {
    mintAttrs += ' data-controller="mint"'
    mintAttrs += ' data-action="wallet:connected@window->mint#onWalletConnected wallet:disconnected@window->mint#onWalletDisconnected"'
    mintAttrs += ` data-mint-collection-value="${collection.slug}"`
    mintAttrs += ` data-mint-price-value="${collection.price_sats}"`
    mintAttrs += ` data-mint-payment-address-value="${collection.payment_address}"`
    mintAttrs += ` data-mint-lowest-inscription-utxo-size-value="${collection.lowest_inscription_utxo_size}"`
    mintAttrs += ` data-mint-seller-address-value="${launchpad.seller_address}"`
    if (collection.explicit_fee_rate) {
      mintAttrs += ` data-mint-explicit-fee-rate-value="${collection.explicit_fee_rate}"`
    }
  }
%>

<section class="pb-6" data-testid="launchpad-page"<%- mintAttrs %>>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Left: Artwork -->
    <% if (CONFIG.launchpad_media_gif_url) { %>
      <div class="spam-can p-4" data-testid="launchpad-media">
        <img
          src="<%= CONFIG.launchpad_media_gif_url %>"
          alt="<%= collection.title %>"
          class="w-full aspect-[4/3] object-contain rounded border-2 border-spam-navy"
          data-testid="launchpad-media-gif"
        />
      </div>
    <% } else if (bannerId) { %>
      <div class="spam-can p-4" data-testid="launchpad-media" data-controller="image">
        <div class="relative aspect-[4/3]">
          <div class="absolute inset-0 bg-spam-bone-dark rounded animate-pulse" data-image-target="skeleton"></div>

          <% if (parentInscription && parentInscription.isImage) { %>
            <img
              src="https://ordinals.com/content/<%= encodeURIComponent(bannerId) %>"
              alt="<%= collection.title %>"
              loading="eager"
              decoding="async"
              style="image-rendering: pixelated"
              class="w-full h-full object-contain rounded border-2 border-spam-navy opacity-0 transition-opacity duration-300"
              data-image-target="img"
              data-action="load->image#loaded error->image#error"
              data-testid="launchpad-media-img"
            />
          <% } else { %>
            <iframe
              src="https://ordinals.com/preview/<%= encodeURIComponent(bannerId) %>"
              class="w-full h-full rounded border-2 border-spam-navy pointer-events-none opacity-0 transition-opacity duration-300"
              allow="accelerometer; gyroscope"
              data-image-target="media"
              data-action="load->image#loaded error->image#error"
              data-testid="launchpad-media-iframe"
            ></iframe>
          <% } %>
        </div>
      </div>
    <% } else { %>
      <div class="spam-can p-4" data-testid="launchpad-media">
        <div class="w-full aspect-[4/3] rounded border-2 border-spam-navy bg-spam-bone flex items-center justify-center">
          <span class="text-5xl">ðŸ¥«</span>
        </div>
      </div>
    <% } %>

    <!-- Right: Mint info / details -->
    <div class="spam-can p-6" data-testid="launchpad-details">
      <h1 class="font-display text-2xl text-spam-navy mb-2" data-testid="launchpad-title"><%= collection.title %></h1>

      <% if (collection.description) { %>
        <p class="font-body text-base leading-relaxed text-spam-navy mb-4" data-testid="launchpad-description"><%= collection.description %></p>
      <% } %>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="rounded-lg border-2 border-spam-navy bg-spam-bone p-4">
          <div class="font-body text-xs uppercase tracking-wide text-spam-navy/80">Price</div>
          <div class="font-display text-xl text-spam-navy" data-testid="launchpad-price"><%= collection.price_sats %> sats</div>
        </div>

        <div class="rounded-lg border-2 border-spam-navy bg-spam-bone p-4">
          <div class="font-body text-xs uppercase tracking-wide text-spam-navy/80">Supply</div>
          <div class="font-display text-xl text-spam-navy" data-testid="launchpad-supply">
            <%= supply.remaining %> / <%= supply.total %>
          </div>
        </div>
      </div>

      <% if (supply.isSoldOut || !supply.hasMintable) { %>
        <div class="rounded-xl border-4 border-spam-navy bg-spam-bone p-6 text-center" data-testid="launchpad-sold-out">
          <div class="text-5xl mb-3">ðŸ¥«</div>
          <div class="font-display text-xl text-spam-navy mb-1">Sold out</div>
          <div class="font-body text-sm text-spam-navy/80">No mintable items available right now.</div>
        </div>
      <% } else { %>
        <div class="space-y-3" data-testid="launchpad-mint">
          <button
            type="button"
            class="w-full rounded-xl border-4 border-spam-navy bg-spam-green px-6 py-4 font-display text-lg text-spam-navy hover:bg-spam-bone transition-colors"
            data-action="click->mint#mint"
            data-testid="mint-button"
          >
            Mint
          </button>

          <div class="font-body text-sm text-spam-navy/80">
            Connect your wallet to mint.
          </div>
        </div>
      <% } %>

      <!-- OP_RETURN Message box (replaces old links/buttons) -->
      <div class="mt-6 pt-6 border-t-2 border-spam-navy/20" data-testid="opreturn-section">
        <div class="rounded-xl border-4 border-spam-navy bg-spam-bone p-5">
          <div class="flex items-center justify-between gap-4 mb-3">
            <div class="font-display text-lg text-spam-navy">OP_RETURN Message</div>
            <button
              type="button"
              class="rounded-lg border-2 border-spam-navy bg-spam-yellow px-4 py-2 font-display text-sm text-spam-navy hover:bg-spam-cream transition-colors"
              id="opreturn-randomise"
            >
              Randomise
            </button>
          </div>

          <div class="font-body text-xs text-spam-navy/70 mb-2">
            The Knotzi regime requires a minimum of 80kb OPRETURN data per Knotzi, irrespecitve of rank.
            <span class="ml-2 font-display" id="opreturn-bytes">0 bytes</span>
          </div>

          <textarea
            id="opreturn-message"
            class="w-full min-h-[110px] rounded-lg border-2 border-spam-navy bg-spam-cream p-3 font-body text-sm text-spam-navy"
            readonly
          ></textarea>

          <!-- Hidden field so mint code can read it -->
          <input type="hidden" id="opreturn-message-hidden" name="op_return_message" value="" />
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const enc = new TextEncoder()

      function byteLen(str) {
        return enc.encode(str).length
      }

      function setMessage(msg) {
        const ta = document.getElementById("opreturn-message")
        const hidden = document.getElementById("opreturn-message-hidden")
        const bytesEl = document.getElementById("opreturn-bytes")

        if (ta) ta.value = msg
        if (hidden) hidden.value = msg
        if (bytesEl) bytesEl.textContent = byteLen(msg) + " bytes"

        const page = document.querySelector('[data-testid="launchpad-page"]')
        if (page) page.dataset.opReturnMessage = msg
      }

      let LINES = []

      async function loadMessages() {
        const res = await fetch("/opreturn-messages.json", { cache: "no-store" })
        if (!res.ok) throw new Error("Failed to load /opreturn-messages.json (" + res.status + ")")

        const data = await res.json()

        const arr = Array.isArray(data) ? data : Array.isArray(data?.messages) ? data.messages : null
        if (!arr) throw new Error('JSON format not recognised. Use an array, or {"messages":[...]}')

        LINES = arr.map((s) => String(s ?? "").trim()).filter(Boolean)

        if (LINES.length === 0) throw new Error("No messages found in /opreturn-messages.json")
      }

      function randomise() {
        if (!LINES.length) {
          setMessage("Loading OP_RETURN messagesâ€¦")
          return
        }
        const pick = LINES[Math.floor(Math.random() * LINES.length)]
        setMessage(pick)
      }

      const btn = document.getElementById("opreturn-randomise")
      if (btn) btn.addEventListener("click", randomise)

      loadMessages()
        .then(() => {
          randomise()
        })
        .catch((e) => {
          console.error(e)
          setMessage("ERROR loading messages. Check /opreturn-messages.json in /public and console logs.")
        })
    })();
  </script>
</section>
